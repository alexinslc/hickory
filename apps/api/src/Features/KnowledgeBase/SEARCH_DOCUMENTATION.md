# Knowledge Article Search Documentation

## Overview

The Knowledge Article search functionality uses PostgreSQL's full-text search capabilities to provide fast, accurate, and relevance-ranked search results across article titles and content.

## Search Implementation

### Search Vector Generation

Search vectors are automatically generated by PostgreSQL using a **computed column** approach. This ensures:
- Consistent indexing across all articles
- Automatic updates when articles are modified
- No need for manual client-side vector generation
- Better performance through database-level optimization

#### Computed Column Definition

```sql
SearchVector = setweight(to_tsvector('english', coalesce("Title", '')), 'A') || 
               setweight(to_tsvector('english', coalesce("Content", '')), 'B')
```

This creates a full-text search vector with:
- **Weight 'A'** for article titles (highest priority)
- **Weight 'B'** for article content (standard priority)

The weighting system ensures that matches in article titles rank higher than matches in content, improving search relevance for users.

### Search Query Processing

Search queries are processed using PostgreSQL's `plainto_tsquery` function, which:
- Automatically handles special characters and operators
- Provides safe, user-friendly search behavior
- Converts plain text queries into proper tsquery format
- Prevents SQL injection and invalid query syntax

Example:
```csharp
// User searches for: "password reset"
// Converted to: to_tsquery('english', 'password & reset')
articlesQuery.Where(a => a.SearchVector.Matches(
    EF.Functions.PlainToTsQuery("english", searchQuery)))
```

## Search Ranking

### Primary Search (SearchArticlesHandler)

Results are ranked by relevance using PostgreSQL's ranking function:

```csharp
.OrderByDescending(a => a.SearchVector.Rank(
    EF.Functions.PlainToTsQuery("english", searchQuery)))
```

The ranking algorithm considers:
1. **Term frequency**: How often search terms appear
2. **Document length**: Shorter documents with matches rank higher
3. **Weight factors**: Title matches (weight A) score higher than content matches (weight B)
4. **Term proximity**: Words appearing closer together rank higher

When no search query is provided, articles are sorted by most recent published date.

### Suggested Articles (GetSuggestedArticlesHandler)

The suggestion algorithm uses a **priority-based fallback strategy**:

1. **Priority 1 - Category Match**: 
   - Returns articles from the specified category
   - Sorted by: HelpfulCount DESC, ViewCount DESC
   - Used when category is specified and has sufficient articles

2. **Priority 2 - Tag Match**:
   - Returns articles with matching tags
   - Sorted by: Number of matching tags DESC, HelpfulCount DESC, ViewCount DESC
   - Articles with more matching tags rank higher

3. **Priority 3 - Full-Text Search**:
   - Uses ticket title/description for search
   - Sorted by: Search relevance DESC, HelpfulCount DESC
   - Provides semantic matches based on ticket content

4. **Priority 4 - Popular Fallback**:
   - Returns most helpful articles overall
   - Sorted by: HelpfulCount DESC, ViewCount DESC, PublishedAt DESC
   - Used when no other criteria produce results

## Index Configuration

A GIN (Generalized Inverted Index) index is created on the SearchVector column:

```csharp
builder.HasIndex(a => a.SearchVector)
    .HasDatabaseName("IX_KnowledgeArticles_SearchVector")
    .HasMethod("gin");
```

This index enables:
- Fast full-text search queries (typically <10ms for most datasets)
- Efficient ranking calculations
- Support for large article repositories

## Search Features

### Supported Filters

1. **Text Search**: Free-text search across title and content
2. **Status Filter**: Filter by Published, Draft, or Archived status
3. **Category Filter**: Filter by specific category
4. **Tag Filter**: Filter by one or more tags
5. **Pagination**: Page through large result sets

### Search Behavior

- **Default Status**: When no status is specified, only Published articles are returned
- **Empty Search**: Returns all (published) articles sorted by published date
- **Case Insensitive**: Search is case-insensitive
- **Language**: Currently configured for English text search

## Performance Characteristics

- **Search Query Time**: <10ms for typical queries
- **Index Size**: ~40% of table size for GIN index
- **Update Performance**: SearchVector automatically updates on INSERT/UPDATE
- **Concurrent Searches**: Excellent due to read-only index operations

## Migration Guide

### For Existing Data

When applying the migration `20260110022000_FixKnowledgeArticleSearchVector`:

1. Existing SearchVector column is dropped
2. New computed column is created
3. SearchVector is automatically computed for all existing articles
4. GIN index is recreated

No manual data migration or reindexing is required.

### Backward Compatibility

The `GenerateSearchVector` method in `KnowledgeArticleHelpers` is marked as `[Obsolete]` but retained for compatibility. It always returns `null` since SearchVector generation is now database-managed.

Developers should remove calls to this method from their code.

## Example Queries

### Basic Text Search

```csharp
var query = new SearchArticlesQuery(
    SearchQuery: "password reset",
    CategoryId: null,
    Tags: null,
    Status: null,
    Page: 1,
    PageSize: 20
);
```

### Category + Tag Filter

```csharp
var query = new SearchArticlesQuery(
    SearchQuery: "authentication",
    CategoryId: categoryId,
    Tags: new List<string> { "security", "login" },
    Status: ArticleStatus.Published,
    Page: 1,
    PageSize: 20
);
```

### Get Suggested Articles

```csharp
var query = new GetSuggestedArticlesQuery(
    TicketTitle: "Can't log in to my account",
    TicketDescription: "I forgot my password and can't access the reset link",
    CategoryId: accountCategoryId,
    Tags: new List<string> { "login", "password" },
    Limit: 5
);
```

## Technical References

- [PostgreSQL Full-Text Search Documentation](https://www.postgresql.org/docs/current/textsearch.html)
- [Npgsql EF Core Full-Text Search](https://www.npgsql.org/efcore/mapping/full-text-search.html)
- [EF Core 9.0 Computed Columns](https://learn.microsoft.com/en-us/ef/core/modeling/generated-properties)

## Future Enhancements

Potential improvements for the search functionality:

1. **Multi-language Support**: Add language detection and appropriate dictionaries
2. **Custom Ranking Weights**: Make weights configurable per deployment
3. **Search Analytics**: Track popular queries and zero-result searches
4. **Highlighting**: Return search term highlights in results
5. **Fuzzy Matching**: Add support for typo tolerance
6. **Synonym Support**: Configure synonyms for domain-specific terminology
